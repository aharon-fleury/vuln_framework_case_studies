---
title: "8_spatial_mapping"
author: "Aharon Fleury"
date: "2023-06-19"
output: html_document
---

``` {r setup, echo = TRUE, message = FALSE, warning = FALSE}
knitr::opts_chunk$set(fig.width = 6, fig.height = 4, fig.path = 'figs/',
                      echo = TRUE, message = FALSE, warning = FALSE)


library(oharac) ### remotes::install_github('oharac/oharac')
library(data.table)
library(tidyverse)
library(here)
library(units)
library(sf)
library(terra)
library(raster)
library(broom)
source(here('common_fxns.R'))


```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r view raster}
worldtif_file_f <- here('_raw_data/spatial', 
                        'world_NatEr1_SR_Wat_Lrg/NE1_HR_LC_SR_W.tif')
worldtif_file <- raster(worldtif_file_f)
natearth_obj <- brick(worldtif_file_f) 
natearth_extent <- extent(-95, -60, 5, 35)
natearth_raster <- crop(natearth_obj, natearth_extent)
plotRGB(natearth_raster, interpolate = TRUE)

coastline_shapefile <- st_read(here('_raw_data/spatial', 'ne_10m_coastline/ne_10m_coastline.shp'))
coastline_shapefile <- st_transform(coastline_shapefile, crs(natearth_raster))
options(progress = "text", chunksize = 100)
blank_raster <- raster(nrow=natearth_raster@nrows, ncol=natearth_raster@ncols, extent(natearth_raster), crs=natearth_raster@crs, vals=NA)
raster_overlay <- rasterize(coastline_shapefile, natearth_raster)
overlay_result <- overlay(natearth_raster, raster_overlay, fun = function(x,y){return(x*y)})
plotRGB(overlay_result, interpolate = TRUE)

plotRGB(natearth_raster, interpolate = TRUE)
lines(coastline_shapefile)

buffer_in_km <- 30
buffer_as_arc_degrees <- buffer_in_km/40075 * 360
buffer <- coastline_shapefile %>%
  st_buffer(buffer_as_arc_degrees)
crs <- st_crs(coastline_shapefile)
buffer <- st_set_crs(buffer, crs)
buffer_raster <- rasterize(buffer, natearth_raster)


# output <- here('_raw_data/spatial')
# writeOGR(coastline_polygon, output, "coastlines", driver = 'ESRI Shapefile' )
```

```{r caribbean map}

countries_shp <- st_read(here('_raw_data/spatial', 'ne_10m_admin_0_countries/ne_10m_admin_0_countries.shp'))

#Bounding the area to the Caribbean and changing the projection to oblique lambert azimuthal equal-area.
countries_shp_car <- countries_shp %>% 
  st_make_valid() %>% 
  st_geometry() %>% 
  st_crop(xmin = -60, xmax = -90,
          ymin = 7, ymax = 35) %>% 
  st_transform(crs = st_crs("+proj=laea +lon_0=-75 +lat_0=21 +datum=WGS84 +units=m +no_defs"))

#For stage 3 and 4 buffer, need a map with and without Bermuda.

countries_shp_not_bermuda <- countries_shp %>% 
  filter(ADMIN != 'Bermuda') %>% 
  st_make_valid() %>% 
  st_geometry() %>% 
  st_crop(xmin = -60, xmax = -90,
          ymin = 7, ymax = 35) %>% 
  st_transform(crs = st_crs("+proj=laea +lon_0=-75 +lat_0=21 +datum=WGS84 +units=m +no_defs"))

countries_shp_bermuda <- countries_shp %>% 
  filter(ADMIN == 'Bermuda') %>% 
  st_make_valid() %>% 
  st_geometry() %>% 
  st_crop(xmin = -60, xmax = -90,
          ymin = 7, ymax = 35) %>% 
  st_transform(crs = st_crs("+proj=laea +lon_0=-75 +lat_0=21 +datum=WGS84 +units=m +no_defs"))
```

```{r stage1 poly}

#Generating the stage 1 polygons off the coastlines of Florida and Costa Rica

stg1_CR_mtrx <- matrix(c(
  -83.7, 10.9,
  -83.13, 9.96,
  -77.08, 13.25,
  -79.81, 14.77,
  -83.7, 10.9
), ncol = 2, byrow = TRUE)

stg1_FL_mtrx <- matrix(c(
  -81.47, 30.23,
  -80.36, 25.98,
  -74.63, 25.05,
  -75.03, 28.88,
  -81.47, 30.23
), ncol = 2, byrow = TRUE)


stg1_CR_poly_tf <- stg1_CR_mtrx %>% 
  list() %>% 
  st_polygon() %>% 
  st_sfc(crs = 4326) %>% 
  st_transform(crs = crs(countries_shp_car))

stg1_FL_poly_tf <- stg1_FL_mtrx %>% 
  list() %>% 
  st_polygon() %>% 
  st_sfc(crs = 4326) %>% 
  st_transform(crs = crs(countries_shp_car))

stg1_poly_tf <- st_sfc(rbind(stg1_CR_poly_tf, stg1_FL_poly_tf), crs = st_crs(countries_shp_car))

stg1_poly <- st_difference(stg1_poly_tf, st_union(countries_shp_car)) 



stage1_plot <- ggplot() + 
  geom_sf(data = countries_shp_car) +
  geom_sf(data = stg1_poly, fill = "deepskyblue1")
  
ggsave(here('_data/sp_poly/stage1_polygon.png'), height = 6, width = 6, dpi = 300)

knitr::include_graphics(here('_data/sp_poly/stage1_polygon.png'))
  

```
```{r stage2 poly}

#Generating the stage 2 polygon in the midst of the two gyres.
stg2_mtrx <- matrix(c(
  -77.08, 13.25, #BR
  -79.81, 14.77, #TL
  -79.07, 16.81,
  -71.65, 16.65,
  -67.76, 19.91,
  -74.63, 25.05, #BRFL
  -75.03, 28.88, #TLFL
  -67.04, 31.24,
  -58.25, 27.93,
  -59.14, 15.14,
  -67.09, 13.69,
  -72.04, 13.49,
  -77.08, 13.25
  ), ncol = 2, byrow = TRUE)



stg2_poly_tf <- stg2_mtrx %>% 
  list() %>% 
  st_polygon() %>% 
  st_sfc(crs = 4326) %>% 
  st_transform(crs = crs(countries_shp_car))

stg2_poly <- st_difference(stg2_poly_tf, st_union(countries_shp_car)) 



stage1_plot <- ggplot() + 
  geom_sf(data = countries_shp_car) +
  geom_sf(data = stg2_poly, fill = "deepskyblue1")

ggsave(here('_data/sp_poly/stage2_polygon.png'), height = 6, width = 6, dpi = 300)

knitr::include_graphics(here('_data/sp_poly/stage2_polygon.png'))
  

```

```{r stage3_4 poly}

#Creating a polygon using a rough estimate of 30 km from the coastline for Stage 3 and 4 turtles. Maps show most of their time is roughly within a 30 km distance although occasionally some tracks cross the Caribbean. Focused on the majority of the time, which is feeding on seagrass within the 30 km distance. Bermuda was the exeption where there the shallow water quickly disappears <5km from the island.

car_buffer <- st_buffer(countries_shp_not_bermuda, dist = 30000, singleSide = TRUE)
bermuda_buffer <- st_buffer(countries_shp_bermuda, dist = 5000, singleSide = TRUE)

buffer_bind <- st_sfc(rbind(bermuda_buffer, car_buffer), crs = st_crs(countries_shp_car))

buffer_poly <- st_difference(buffer_bind, st_union(countries_shp_car))

#Matrices for Caribbean without and with Bermuda to calculate intersection of just the Caribbean coastlines and not those in the eastern Pacific of some of the countries or the Gulf of Mexico.

car_mtrx <- matrix(c(
  -61.34, 9.10,
  -72.95, 10.91,
  -76.88, 7.54,
  -78.22, 8.94,
  -79.49, 9.26,
  -81.99, 8.38,
  -84.76, 11.76,
  -89.93, 16.54,
  -88.45, 21.42,
  -84.69, 30.29,
  -62.93, 31.32,
  -59.90, 13.49,
  -60.52, 9.35,
  -61.34, 9.10
  ), ncol = 2, byrow = TRUE)

bermuda_mtrx <- matrix(c(
  -66.47, 33.36,
  -63.04, 33.37,
  -62.98, 31.08,
  -66.63, 31.16,
  -66.47, 33.36
  ), ncol = 2, byrow = TRUE)

# Applying CRS to polygons for Caribbean with and without Bermuda.

car_poly_tf <- car_mtrx %>% 
  list() %>% 
  st_polygon() %>% 
  st_sfc(crs = 4326) %>% 
  st_transform(crs = crs(countries_shp_not_bermuda))

bermuda_poly_tf <- bermuda_mtrx %>% 
  list() %>% 
  st_polygon() %>% 
  st_sfc(crs = 4326) %>% 
  st_transform(crs = crs(countries_shp_bermuda))


#Binds the two polys for the Caribbean and Bermuda and adjusts their CRS.

car_poly_tf <- st_sfc(rbind(car_poly_tf, bermuda_poly_tf), crs = st_crs(countries_shp_car))

# This final function allows us to create a polygon only on the coastlines we are interested in. 

car_poly <- st_intersection(buffer_poly, car_poly_tf) 


stg3_4_plot <- ggplot()+
  geom_sf(data = car_poly_tf)
  geom_sf(data = car_poly, fill = "deepskyblue1") +
  geom_sf(data = countries_shp_car)

ggsave(here('_data/sp_poly/stage3_4_polygon.png'), height = 6, width = 6, dpi = 300)

knitr::include_graphics(here('_data/sp_poly/stage3_4_polygon.png'))

```

You can also embed plots, for example:

```{r aquamaps, echo=FALSE}

amturtle <- data.table::fread(here('_raw_data/spatial', 'aquamaps_mydas.csv'), skip = 13)

amturtle_sf <- amturtle %>% 
  st_as_sf(coords = c("Center Long", "Center Lat")) %>% 
  st_set_crs(4326) %>% 
  st_crop(xmin = -60, xmax = -90,
          ymin = 7, ymax = 35) 
# %>% 
#   st_transform(crs = st_crs("+proj=laea +lon_0=-75 +lat_0=21 +datum=WGS84 +units=m +no_defs")) 

countries_shp_car_WGS84 <- countries_shp %>% 
  st_make_valid() %>% 
  st_geometry() %>% 
  st_crop(xmin = -60, xmax = -90,
          ymin = 7, ymax = 35)

grid <- sf::st_make_grid(countries_shp_car_WGS84,
                          square = TRUE,
                          cellsize = c(0.5,0.5), 
                          what = "polygons") %>% 
  sf::st_sf() 

grid_ft <- st_join(grid, amturtle_sf) %>% 
  st_transform(crs = st_crs("+proj=laea +lon_0=-75 +lat_0=21 +datum=WGS84 +units=m +no_defs")) %>% 
  filter(!is.na(`Overall Probability`))

#Targeting specifically the Caribbean, similar to the buffer poly for adult stages.
grid_car <- st_intersection(grid_ft, car_poly_tf)

#Removing overlapping land masses from grid cells
grid_poly <- st_difference(grid_car, st_union(countries_shp_car))



ggplot() + 
  geom_sf(data = amturtle_sf, aes(fill = `Overall Probability`)) +
  geom_sf(data = countries_shp_car)

```

```{r importing Caseys stressor mols, echo=FALSE}


am_rast <- terra::rast(grid_poly)

am_df <- am_rast %>% 
  as.data.frame(xy = TRUE)


mp_tif <- terra::rast(here('_data/stressors_mol', 'microplastics_2015.tif'))

mp_df <- mp_tif %>% 
  as.data.frame(xy = TRUE)

mp_sf <- mp_df %>% 
  st_as_sf(coords = c("x", "y"), crs = "PROJCRS[\"unknown\",\n    BASEGEOGCRS[\"GCS_unknown\",\n        DATUM[\"World Geodetic System 1984\",\n            ELLIPSOID[\"WGS 84\",6378137,298.257223563,\n                LENGTHUNIT[\"metre\",1]],\n            ID[\"EPSG\",6326]],\n        PRIMEM[\"Greenwich\",0,\n            ANGLEUNIT[\"Degree\",0.0174532925199433]]],\n    CONVERSION[\"unnamed\",\n        METHOD[\"Mollweide\"],\n        PARAMETER[\"Longitude of natural origin\",0,\n            ANGLEUNIT[\"Degree\",0.0174532925199433],\n            ID[\"EPSG\",8802]],\n        PARAMETER[\"False easting\",0,\n            LENGTHUNIT[\"metre\",1],\n            ID[\"EPSG\",8806]],\n        PARAMETER[\"False northing\",0,\n            LENGTHUNIT[\"metre\",1],\n            ID[\"EPSG\",8807]]],\n    CS[Cartesian,2],\n        AXIS[\"(E)\",east,\n            ORDER[1],\n            LENGTHUNIT[\"metre\",1,\n                ID[\"EPSG\",9001]]],\n        AXIS[\"(N)\",north,\n            ORDER[2],\n            LENGTHUNIT[\"metre\",1,\n                ID[\"EPSG\",9001]]]]" )

mp_car <- mp_sf %>% 
  st_transform(crs = 4326) %>% 
  st_crop(xmin = -60, xmax = -90,
          ymin = 7, ymax = 35)

mp_car_0 <- mp_car %>% 
  !is.na(microplastics_2015)


ship_tif <- terra::rast(here('_data/stressors_mol', 'shipping_all_unweighted_2021.tif'))

ship_df <- ship_tif %>% 
  as.data.frame(xy = TRUE)

ship_sf <- ship_df %>% 
  st_as_sf(coords = c("x", "y"), crs = "PROJCRS[\"unknown\",\n    BASEGEOGCRS[\"GCS_unknown\",\n        DATUM[\"World Geodetic System 1984\",\n            ELLIPSOID[\"WGS 84\",6378137,298.257223563,\n                LENGTHUNIT[\"metre\",1]],\n            ID[\"EPSG\",6326]],\n        PRIMEM[\"Greenwich\",0,\n            ANGLEUNIT[\"Degree\",0.0174532925199433]]],\n    CONVERSION[\"unnamed\",\n        METHOD[\"Mollweide\"],\n        PARAMETER[\"Longitude of natural origin\",0,\n            ANGLEUNIT[\"Degree\",0.0174532925199433],\n            ID[\"EPSG\",8802]],\n        PARAMETER[\"False easting\",0,\n            LENGTHUNIT[\"metre\",1],\n            ID[\"EPSG\",8806]],\n        PARAMETER[\"False northing\",0,\n            LENGTHUNIT[\"metre\",1],\n            ID[\"EPSG\",8807]]],\n    CS[Cartesian,2],\n        AXIS[\"(E)\",east,\n            ORDER[1],\n            LENGTHUNIT[\"metre\",1,\n                ID[\"EPSG\",9001]]],\n        AXIS[\"(N)\",north,\n            ORDER[2],\n            LENGTHUNIT[\"metre\",1,\n                ID[\"EPSG\",9001]]]]" )

ship_car <- ship_sf %>% 
  st_transform(crs = 4326) %>% 
  st_crop(xmin = -60, xmax = -90,
          ymin = 7, ymax = 35)

#The crs is reprojecting but the units fo the bounding box don't change, why?

    
# %>% 
#   st_transform(crs = st_crs("+proj=laea +lon_0=-75 +lat_0=21 +datum=WGS84 +units=m +no_defs")) 

grid_mp <- sf::st_make_grid(mp_sf,
                          crs = '+proj=moll +lon_0=0 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m',
                          square = TRUE,
                          cellsize = c(10000, 10000), 
                          what = "polygons") %>% 
  sf::st_sf() 

#Making grid in mollweide projection to extract bounding box values.
grid_basis <- grid %>% 
  st_transform(crs = "PROJCRS[\"unknown\",\n    BASEGEOGCRS[\"GCS_unknown\",\n        DATUM[\"World Geodetic System 1984\",\n            ELLIPSOID[\"WGS 84\",6378137,298.257223563,\n                LENGTHUNIT[\"metre\",1]],\n            ID[\"EPSG\",6326]],\n        PRIMEM[\"Greenwich\",0,\n            ANGLEUNIT[\"Degree\",0.0174532925199433]]],\n    CONVERSION[\"unnamed\",\n        METHOD[\"Mollweide\"],\n        PARAMETER[\"Longitude of natural origin\",0,\n            ANGLEUNIT[\"Degree\",0.0174532925199433],\n            ID[\"EPSG\",8802]],\n        PARAMETER[\"False easting\",0,\n            LENGTHUNIT[\"metre\",1],\n            ID[\"EPSG\",8806]],\n        PARAMETER[\"False northing\",0,\n            LENGTHUNIT[\"metre\",1],\n            ID[\"EPSG\",8807]]],\n    CS[Cartesian,2],\n        AXIS[\"(E)\",east,\n            ORDER[1],\n            LENGTHUNIT[\"metre\",1,\n                ID[\"EPSG\",9001]]],\n        AXIS[\"(N)\",north,\n            ORDER[2],\n            LENGTHUNIT[\"metre\",1,\n                ID[\"EPSG\",9001]]]]")

#Mollweide crop
grid_car <- grid_mp %>% 
  st_crop(xmin = -5228493 , xmax = -8978506,
          ymin = 864688.7, ymax = 4337580)

grid_car_wgs <- grid_car %>% 
  st_transform(crs = 4326) %>% 
  st_crop(xmin = -60, xmax = -90,
          ymin = 7, ymax = 35)

grid_ft_mp <- st_join(grid_car_wgs, mp_car_0) %>% 
  st_transform(crs = st_crs("+proj=laea +lon_0=-75 +lat_0=21 +datum=WGS84 +units=m +no_defs")) 

grid_ft_mp2 <- grid_ft_mp %>% 
  filter(!is.na(microplastics_2015))

grid_ft_ship <- st_join(grid_car_wgs, ship_car) %>% 
  st_transform(crs = st_crs("+proj=laea +lon_0=-75 +lat_0=21 +datum=WGS84 +units=m +no_defs")) 

write_rds(grid_ft_ship, file = here('_data/stressors_mol/unweighted_shipping_car.rds'))


ggplot() + 
  geom_sf(data = grid_ft_mp2, aes(color = `microplastics_2015`)) +
  geom_sf(data = countries_shp_car)

  ggplot() + 
  geom_sf(data = grid_ft_ship, aes(fill = `shipping_all_unweighted_2021`), color = NA) + 
  geom_sf(data = countries_shp_car) 

```

```{r area-weighted interpolation of polygons, echo=FALSE}

# grid_ft_shp <- read_rds(here('_data/stressors_mol/unweighted_shipping_car.rds'))
# https://r.geocompx.org/spatial-operations.html



awi <- st_interpolate_aw(grid_ft_ship, grid_poly, extensive = FALSE)

test2 <- st_join(grid_poly, awi, join = st_within)

ggplot() + 
  geom_sf(data = test)

ggplot() + 
  geom_sf(data = test3, aes(fill = `shipping_all_unweighted_2021`)) +
  geom_sf(data = countries_shp_car) 

```